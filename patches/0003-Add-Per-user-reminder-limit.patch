From f6d4d2ae9c1d0e50c594e0249b80ae438761b5a4 Mon Sep 17 00:00:00 2001
From: Ritchie Cunningham <ritchie@ritchiecunningham.co.uk>
Date: Fri, 14 Nov 2025 23:24:34 +0000
Subject: [PATCH 3/8] [Add] Per-user reminder limit.

---
 cmd/skuzzy/reminders.go | 51 +++++++++++++++++++++++++++--------------
 cmd/skuzzy/settings.go  |  6 ++---
 libera-example.yaml     |  1 +
 3 files changed, 38 insertions(+), 20 deletions(-)

diff --git a/cmd/Skuzzy/reminders.go b/cmd/Skuzzy/reminders.go
index 1d833ae..3056887 100644
--- a/cmd/Skuzzy/reminders.go
+++ b/cmd/Skuzzy/reminders.go
@@ -9,19 +9,19 @@ import (
 
 /* Holds information for a single reminder. */
 type Reminder struct {
-	Server		string
-	Channel		string
-	User			string
-	Message		string
-	EndTime		time.Time
-	Timer			*time.Timer
+	Server  string
+	Channel string
+	User    string
+	Message string
+	EndTime time.Time
+	Timer   *time.Timer
 }
 
 var (
 	/* Holds all active reminders, keyed by a server/channel string. */
-	Reminders			= make(map[string][]*Reminder)
+	Reminders = make(map[string][]*Reminder)
 	/* Protect against concurrent access. */
-	ReminderMutex	= sync.RWMutex{}
+	ReminderMutex = sync.RWMutex{}
 )
 
 /* Schdules a new reminder. */
@@ -29,25 +29,42 @@ func AddReminder(settings *ServerConfig, reminder *Reminder) {
 	ReminderMutex.Lock()
 	defer ReminderMutex.Unlock()
 
+	/* Try eat up all our RAM with your silly reminders now!!11! */
+	userReminderCount := 0
 	key := fmt.Sprintf("%s/%s", reminder.Server, reminder.Channel)
+	if existingReminders, ok := Reminders[key]; ok {
+		for _, r := range existingReminders {
+			if r.User == reminder.User {
+				userReminderCount++
+			}
+		}
+	}
+	if userReminderCount >= settings.MaxRemindersPerUser {
+		send_irc(reminder.Server, reminder.Channel, fmt.Sprintf("%s: You have reached "+
+			"your limit of %d active reminders "+
+			"in this channel",
+			reminder.User, settings.MaxRemindersPerUser))
+		return
+	}
+
 	Reminders[key] = append(Reminders[key], reminder)
 	log.Printf("Scheduled reminder for %s in channel %s: %s", reminder.User,
-						reminder.Channel, reminder.Message)
+		reminder.Channel, reminder.Message)
 
 	/* Schedule the reminder. */
 	reminder.Timer = time.AfterFunc(time.Until(reminder.EndTime), func() {
 		/*
-	   * When the timer fires, create a request for the LLM to generate
-	   * the reminder message.
-	   */
+		 * When the timer fires, create a request for the LLM to generate
+		 * the reminder message.
+		 */
 		reminderPrompt := fmt.Sprintf(settings.SysPrompts["reminder_fire"],
-											reminder.User, reminder.Message)
+			reminder.User, reminder.Message)
 
 		/* Send the reminder_fire prompt. */
-		req := DeepseekRequest {
-			channel:		reminder.Channel,
-			request:		reminderPrompt,
-			sysprompt:	settings.SysPrompts["reminder_fire"],
+		req := DeepseekRequest{
+			channel:   reminder.Channel,
+			request:   reminderPrompt,
+			sysprompt: settings.SysPrompts["reminder_fire"],
 		}
 		DeepseekQueue <- req
 
diff --git a/cmd/Skuzzy/settings.go b/cmd/Skuzzy/settings.go
index 16294f2..84e6e4a 100644
--- a/cmd/Skuzzy/settings.go
+++ b/cmd/Skuzzy/settings.go
@@ -6,12 +6,11 @@ import (
 	"os"
 )
 
-
 type ChannelConfig struct {
 	Name              string   `yaml:"name"`
 	LLM               string   `yaml:"llm,omitempty"`
 	SysPromptsEnabled []string `yaml:"sys_prompts_enabled"`
-	Backlog []string
+	Backlog           []string
 }
 
 type LLM struct {
@@ -33,10 +32,11 @@ type ServerConfig struct {
 	SysPrompts            map[string]string `yaml:"sys_prompts"`
 	SysPromptGlobalPrefix string            `yaml:"sys_prompt_global_suffix"`
 	DeepseekAPIKey        string            `yaml:"deepseek_api_key"`
+	MaxRemindersPerUser   int               `yaml:"max_reminders_per_user"`
 	ServerLogFile         string            `yaml:"server_log_file"`
 }
 
-func LoadServerConfig(path string) (*ServerConfig,error) {
+func LoadServerConfig(path string) (*ServerConfig, error) {
 
 	var config ServerConfig
 
diff --git a/libera-example.yaml b/libera-example.yaml
index 796df8e..a9e4486 100644
--- a/libera-example.yaml
+++ b/libera-example.yaml
@@ -8,6 +8,7 @@ nickservpassword: 'changeme'
 sys_prompt_global_suffix: 'Your response should be less than 800 characters long.'
 deepseek_api_key: 'changeme'
 server_log_file:  'libera.log'
+max_reminders_per_user: 5
 llms:
   - deepseek:
     name: deepseek
-- 
2.48.1

