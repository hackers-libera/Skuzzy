From 1464ce6af9418a18634eee9e33185d0e7172ad3c Mon Sep 17 00:00:00 2001
From: Ritchie Cunningham <ritchie@ritchiecunningham.co.uk>
Date: Fri, 14 Nov 2025 22:50:32 +0000
Subject: [PATCH 2/8] [Fix] Prevent bot from responding to unmentioned
 messages.

---
 cmd/skuzzy/irc.go | 87 ++++++++++++++++++++++++++---------------------
 1 file changed, 49 insertions(+), 38 deletions(-)

diff --git a/cmd/Skuzzy/irc.go b/cmd/Skuzzy/irc.go
index c454bb9..ca7e49e 100644
--- a/cmd/Skuzzy/irc.go
+++ b/cmd/Skuzzy/irc.go
@@ -223,46 +223,58 @@ func irc_loop(settings *ServerConfig) {
 							}
 						}
 						if channel != nil && strings.EqualFold(llm, "deepseek") {
-							reset := false
-
-							var handledAsReminder bool
-							/* Check for reminder keyword. */
-							if rReminder.MatchString(query) {
-								req := DeepseekRequest {
-									channel:				from_channel,
-									request:				query,
-									PromptName:			"reminder_parse",
-									OriginalQuery:	query,
-									User:						user,
-								}
-								DeepseekQueue <- req
-								log.Printf("Deepseek reminder parsing query:\n%v\n", req)
-								handledAsReminder = true
-							}
-							
-							if !handledAsReminder {
-								reload := false
-								mention := mentioned(settings.Nick, query)
-
-								if strings.Contains(query, "@reset") {
-									query = strings.ReplaceAll(query, "@reset", "")
-									reset = true
-								}
-								if strings.Contains(query, "@reload") {
-									query = strings.ReplaceAll(query, "@reload", "")
-									reload = true
+							mention := mentioned(settings.Nick, query)
+							if mention {
+								/* Skuzzy mentioned, process the command. */
+								nickPattern := `(?i)^` + regexp.QuoteMeta(settings.Nick) + `[:, ]*`
+								r, _ := regexp.Compile(nickPattern)
+								cleanQuery := r.ReplaceAllString(query, "")
+
+								/* Check for reminder keyword. */
+								if rReminder.MatchString(cleanQuery) {
+									req := DeepseekRequest {
+										channel:				from_channel,
+										request:				cleanQuery,
+										PromptName:			"reminder_parse",
+										OriginalQuery:	cleanQuery,
+										User:						user,
+									}
+									DeepseekQueue <- req
+									log.Printf("Deepseek reminder parsing query:\n%v\n", req)
+								} else {
+									/* Handle other commands like @reset, @reload, or default chat. */
+									reload := false
+									reset := false
+									if strings.Contains(cleanQuery, "@reset") {
+										cleanQuery = strings.ReplaceAll(cleanQuery, "@reset", "")
+										reset = true
+									}
+									if strings.Contains(cleanQuery, "@reload") {
+										cleanQuery = strings.ReplaceAll(cleanQuery, "@reload", "")
+										reload = true
+									}
+									_, text := FindPrompt(settings, llm, from_channel, cleanQuery)
+									text = strings.Replace(text, "{NICK}", settings.Nick,-1)
+									text = strings.Replace(text, "{USER}", user,-1)
+									text = strings.Replace(text, "{CHANNEL}", from_channel,-1)
+									text = strings.Replace(text, "{BACKLOG}", strings.Join(channel.Backlog,"\n"),-1)
+
+									req := DeepseekRequest{from_channel, text, cleanQuery, reload, reset, "", cleanQuery, user}
+									DeepseekQueue <- req
+									log.Printf("Deepseek query:\n%v\n", req)
 								}
-								prompt, text := FindPrompt(settings, llm, from_channel, query)
-								text = strings.Replace(text, "{NICK}", settings.Nick,-1)
-								text = strings.Replace(text, "{USER}", user,-1)
-								text = strings.Replace(text, "{CHANNEL}", from_channel,-1)
-								text = strings.Replace(text, "{BACKLOG}", strings.Join(channel.Backlog,"\n"),-1)
-								if !mention && strings.HasSuffix(prompt, "/default") {
-									log.Printf("Skipping LLM query due to default prompt, mention, or " +
-														"reminder request.")
+							} else {
+								prompt, _ := FindPrompt(settings, llm, from_channel, query)
+								if strings.HasSuffix(prompt, "/default") {
+									log.Printf("Skipping LLM query due to default prompt and no mention.")
 								} else {
+									_, text := FindPrompt(settings, llm, from_channel, query)
+									text = strings.Replace(text, "{NICK}", settings.Nick,-1)
+									text = strings.Replace(text, "{USER}", user,-1)
+									text = strings.Replace(text, "{CHANNEL}", from_channel,-1)
+									text = strings.Replace(text, "{BACKLOG}", strings.Join(channel.Backlog,"\n"),-1)
 
-									req := DeepseekRequest{from_channel, text, query, reload, reset, "", query, user}
+									req := DeepseekRequest{from_channel, text, query, false, false, "", query, user}
 									DeepseekQueue <- req
 									log.Printf("Deepseek query:\n%v\n", req)
 								}
@@ -271,7 +283,6 @@ func irc_loop(settings *ServerConfig) {
 					}
 				}
 			}
-
 		}
 		if breakout {
 			break
-- 
2.48.1

