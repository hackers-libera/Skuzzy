From 382f17006e0e48b6c509be55d928eede59a357f9 Mon Sep 17 00:00:00 2001
From: Ritchie Cunningham <ritchie@ritchiecunningham.co.uk>
Date: Sat, 15 Nov 2025 00:10:56 +0000
Subject: [PATCH 4/8] [Add] Liset user active reminders.

---
 cmd/skuzzy/irc.go       | 54 ++++++++++++++++++++++-------------------
 cmd/skuzzy/reminders.go | 49 ++++++++++++++++++++++++++++++++++++-
 2 files changed, 77 insertions(+), 26 deletions(-)

diff --git a/cmd/Skuzzy/irc.go b/cmd/Skuzzy/irc.go
index ca7e49e..c3266c3 100644
--- a/cmd/Skuzzy/irc.go
+++ b/cmd/Skuzzy/irc.go
@@ -10,8 +10,8 @@ import (
 	"regexp"
 	"slices"
 	"strings"
-	"time"
 	"sync"
+	"time"
 )
 
 type Connection struct {
@@ -67,10 +67,10 @@ func send_irc_raw(conn Connection, msg string) {
 	fmt.Printf("< %v", msg)
 }
 func send_irc_raw_secret(conn Connection, msg string) {
-    _, err := conn.cx.Write([]byte(msg))
-    if err != nil {
-        log.Printf("Failed to send IRC message containing a secret:\nError:%v\n", err)
-    }
+	_, err := conn.cx.Write([]byte(msg))
+	if err != nil {
+		log.Printf("Failed to send IRC message containing a secret:\nError:%v\n", err)
+	}
 }
 func irc_connect(settings *ServerConfig) error {
 	tlsConfig := &tls.Config{MinVersion: tls.VersionTLS12}
@@ -104,11 +104,12 @@ func CloseConnections() {
 
 func mentioned(nick string, query string) bool {
 
-	return strings.HasPrefix(strings.ToLower(query), strings.ToLower(nick)) 
+	return strings.HasPrefix(strings.ToLower(query), strings.ToLower(nick))
 }
 
 /* Regex to parse reminder requests. */
-var rReminder = regexp.MustCompile(`(?i)remind|reminder`)
+var rReminder = regexp.MustCompile(`(?i)remind|reminder`)          /* Set reminder. */
+var rListReminders = regexp.MustCompile(`(?i)(list|my) reminders`) /* List reminders. */
 
 func irc_loop(settings *ServerConfig) {
 	log.Printf("IRC message loop for %s\n", settings.Name)
@@ -123,7 +124,7 @@ func irc_loop(settings *ServerConfig) {
 	auth_sent := false
 	breakout := false
 
-	cx.SetReadDeadline(time.Now().Add(240*time.Second))
+	cx.SetReadDeadline(time.Now().Add(240 * time.Second))
 
 	for {
 		buf := make([]byte, 65535)
@@ -138,11 +139,11 @@ func irc_loop(settings *ServerConfig) {
 				ConnectionsMutex.RLock()
 				send_irc_raw(Connections[settings.Name], fmt.Sprintf("PING %s\r\n", settings.Host))
 				ConnectionsMutex.RUnlock()
-				cx.SetReadDeadline(time.Now().Add(240*time.Second))
+				cx.SetReadDeadline(time.Now().Add(240 * time.Second))
 				continue
 			}
 		} else if nbytes > 0 {
-			cx.SetReadDeadline(time.Now().Add(240*time.Second))
+			cx.SetReadDeadline(time.Now().Add(240 * time.Second))
 			for _, line := range strings.Split(string(buf), "\n") {
 				response := strings.TrimSpace(line)
 				words := strings.Split(response, " ")
@@ -230,14 +231,17 @@ func irc_loop(settings *ServerConfig) {
 								r, _ := regexp.Compile(nickPattern)
 								cleanQuery := r.ReplaceAllString(query, "")
 
-								/* Check for reminder keyword. */
-								if rReminder.MatchString(cleanQuery) {
+								if rListReminders.MatchString(cleanQuery) {
+									/* List reminders. */
+									send_irc(settings.Name, from_channel, ListReminders(settings, user))
+									log.Printf("Deepseek reminder listing query:\n%v\n", cleanQuery)
+								} else if rReminder.MatchString(cleanQuery) {
 									req := DeepseekRequest {
-										channel:				from_channel,
-										request:				cleanQuery,
-										PromptName:			"reminder_parse",
-										OriginalQuery:	cleanQuery,
-										User:						user,
+										channel:       from_channel,
+										request:       cleanQuery,
+										PromptName:    "reminder_parse",
+										OriginalQuery: cleanQuery,
+										User:          user,
 									}
 									DeepseekQueue <- req
 									log.Printf("Deepseek reminder parsing query:\n%v\n", req)
@@ -254,10 +258,10 @@ func irc_loop(settings *ServerConfig) {
 										reload = true
 									}
 									_, text := FindPrompt(settings, llm, from_channel, cleanQuery)
-									text = strings.Replace(text, "{NICK}", settings.Nick,-1)
-									text = strings.Replace(text, "{USER}", user,-1)
-									text = strings.Replace(text, "{CHANNEL}", from_channel,-1)
-									text = strings.Replace(text, "{BACKLOG}", strings.Join(channel.Backlog,"\n"),-1)
+									text = strings.Replace(text, "{NICK}", settings.Nick, -1)
+									text = strings.Replace(text, "{USER}", user, -1)
+									text = strings.Replace(text, "{CHANNEL}", from_channel, -1)
+									text = strings.Replace(text, "{BACKLOG}", strings.Join(channel.Backlog, "\n"), -1)
 
 									req := DeepseekRequest{from_channel, text, cleanQuery, reload, reset, "", cleanQuery, user}
 									DeepseekQueue <- req
@@ -269,10 +273,10 @@ func irc_loop(settings *ServerConfig) {
 									log.Printf("Skipping LLM query due to default prompt and no mention.")
 								} else {
 									_, text := FindPrompt(settings, llm, from_channel, query)
-									text = strings.Replace(text, "{NICK}", settings.Nick,-1)
-									text = strings.Replace(text, "{USER}", user,-1)
-									text = strings.Replace(text, "{CHANNEL}", from_channel,-1)
-									text = strings.Replace(text, "{BACKLOG}", strings.Join(channel.Backlog,"\n"),-1)
+									text = strings.Replace(text, "{NICK}", settings.Nick, -1)
+									text = strings.Replace(text, "{USER}", user, -1)
+									text = strings.Replace(text, "{CHANNEL}", from_channel, -1)
+									text = strings.Replace(text, "{BACKLOG}", strings.Join(channel.Backlog, "\n"), -1)
 
 									req := DeepseekRequest{from_channel, text, query, false, false, "", query, user}
 									DeepseekQueue <- req
diff --git a/cmd/Skuzzy/reminders.go b/cmd/Skuzzy/reminders.go
index 3056887..42ac4d4 100644
--- a/cmd/Skuzzy/reminders.go
+++ b/cmd/Skuzzy/reminders.go
@@ -3,12 +3,14 @@ package main
 import (
 	"fmt"
 	"log"
+	"strings"
 	"sync"
 	"time"
 )
 
 /* Holds information for a single reminder. */
 type Reminder struct {
+	ID      int
 	Server  string
 	Channel string
 	User    string
@@ -21,7 +23,8 @@ var (
 	/* Holds all active reminders, keyed by a server/channel string. */
 	Reminders = make(map[string][]*Reminder)
 	/* Protect against concurrent access. */
-	ReminderMutex = sync.RWMutex{}
+	ReminderMutex  = sync.RWMutex{}
+	nextReminderID = 1
 )
 
 /* Schdules a new reminder. */
@@ -47,6 +50,8 @@ func AddReminder(settings *ServerConfig, reminder *Reminder) {
 		return
 	}
 
+	reminder.ID = nextReminderID
+	nextReminderID++
 	Reminders[key] = append(Reminders[key], reminder)
 	log.Printf("Scheduled reminder for %s in channel %s: %s", reminder.User,
 		reminder.Channel, reminder.Message)
@@ -91,3 +96,45 @@ func RemoveReminder(reminder *Reminder) {
 		}
 	}
 }
+
+/* Retrieve and format a user's active reminders. */
+func ListReminders(settings *ServerConfig, user string) string {
+	ReminderMutex.RLock()
+	defer ReminderMutex.RUnlock()
+
+	var userReminders []*Reminder
+	for _, reminderList := range Reminders {
+		for _, r := range reminderList {
+			if r.User == user {
+				userReminders = append(userReminders, r)
+			}
+		}
+	}
+
+	if len(userReminders) == 0 {
+		return fmt.Sprintf("%s: You have no active reminders.", user)
+	}
+
+	var response strings.Builder
+	response.WriteString(fmt.Sprintf("%s: Your active reminders:", user))
+	for i, r := range userReminders {
+		timeRemaining := time.Until(r.EndTime)
+		response.WriteString(fmt.Sprintf(" %d. ID: %d - \"%s\" (in %s) ",
+			i+1, r.ID, r.Message, formatDuration(timeRemaining)))
+	}
+	return response.String()
+}
+
+/* Format duration. */
+func formatDuration(d time.Duration) string {
+	/* Currently, we only do whole minutes, but just in case that changes. */
+	if d < time.Minute {
+		return fmt.Sprintf("%d seconds", int(d.Seconds()))
+	} else if d < time.Hour {
+		return fmt.Sprintf("%d minutes", int(d.Minutes()))
+	} else if d < 24*time.Hour {
+		return fmt.Sprintf("%d hours %d minutes", int(d.Hours()), int(d.Minutes())%60)
+	} else {
+		return fmt.Sprintf("%d days %d hours", int(d.Hours()/24), int(d.Hours())%24)
+	}
+}
-- 
2.48.1

