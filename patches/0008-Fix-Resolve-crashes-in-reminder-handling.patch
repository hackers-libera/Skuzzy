From 761a7c7509d59abd93041d614f4ef65faeb87cc9 Mon Sep 17 00:00:00 2001
From: Ritchie Cunningham <ritchie@ritchiecunningham.co.uk>
Date: Sat, 15 Nov 2025 02:46:55 +0000
Subject: [PATCH 8/8] [Fix] Resolve crashes in reminder handling.

---
 cmd/skuzzy/reminder_handler.go |  1 +
 cmd/skuzzy/reminders.go        | 10 ++++++----
 2 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/cmd/Skuzzy/reminder_handler.go b/cmd/Skuzzy/reminder_handler.go
index 703a722..831d704 100644
--- a/cmd/Skuzzy/reminder_handler.go
+++ b/cmd/Skuzzy/reminder_handler.go
@@ -102,6 +102,7 @@ func requeueAsChat(settings *ServerConfig, originalReq DeepseekRequest) {
 
 	/* Create and send the new request for general processing. */
 	req := DeepseekRequest{
+		Server:    originalReq.Server,
 		channel:   originalReq.channel,
 		sysprompt: text,
 		request:   originalReq.OriginalQuery,
diff --git a/cmd/Skuzzy/reminders.go b/cmd/Skuzzy/reminders.go
index 3dda55a..b22415b 100644
--- a/cmd/Skuzzy/reminders.go
+++ b/cmd/Skuzzy/reminders.go
@@ -62,14 +62,16 @@ func AddReminder(settings *ServerConfig, reminder *Reminder) {
 		 * When the timer fires, create a request for the LLM to generate
 		 * the reminder message.
 		 */
-		reminderPrompt := fmt.Sprintf(settings.SysPrompts["reminder_fire"],
-			reminder.User, reminder.Message)
+		sysPrompt := settings.SysPrompts["reminder_fire"]
+		sysPrompt = strings.Replace(sysPrompt, "{USER}", reminder.User, -1)
+		sysPrompt = strings.Replace(sysPrompt, "{MESSAGE}", reminder.Message, -1)
 
 		/* Send the reminder_fire prompt. */
 		req := DeepseekRequest{
+			Server:    reminder.Server,
 			channel:   reminder.Channel,
-			request:   reminderPrompt,
-			sysprompt: settings.SysPrompts["reminder_fire"],
+			request:   "The reminder is now due. Please generate the notification.",
+			sysprompt: sysPrompt,
 		}
 		DeepseekQueue <- req
 
-- 
2.48.1

